!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mini-Consulta IA Dr. Thiago</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .chat-container {
      width: 100%;
      max-width: 480px;
      height: 90vh;
      max-height: 720px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-header {
      padding: 12px 16px;
      background: #0f172a;
      color: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .chat-header-title {
      font-size: 16px;
      font-weight: 600;
    }
    .chat-header-subtitle {
      font-size: 12px;
      opacity: 0.8;
    }
    .chat-messages {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      background: #e5e7eb;
    }
    .message {
      max-width: 90%;
      margin-bottom: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    .message.user {
      margin-left: auto;
      background: #22c55e;
      color: #052e16;
      border-bottom-right-radius: 0;
    }
    .message.bot {
      margin-right: auto;
      background: #ffffff;
      color: #111827;
      border-bottom-left-radius: 0;
    }
    .chat-input-area {
      padding: 10px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 8px;
    }
    .chat-input-area input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      outline: none;
    }
    .chat-input-area button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #0f172a;
      color: #f9fafb;
      font-size: 14px;
      cursor: pointer;
    }
    .chat-input-area button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .typing {
      font-size: 12px;
      color: #6b7280;
      padding: 0 12px 6px;
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-header-title">Mini-Consulta IA Dr. Thiago</div>
      <div class="chat-header-subtitle">
        Avalia√ß√£o educativa de h√©rnias, di√°stase e parede abdominal. N√£o substitui consulta presencial.
      </div>
    </div>
    <div id="messages" class="chat-messages"></div>
    <div id="typing" class="typing"></div>
    <div class="chat-input-area">
      <input id="userInput" type="text" placeholder="Digite sua mensagem..." />
      <button id="sendBtn">Enviar</button>
    </div>
  </div>

  <script>
    // üß† Aqui fica o PROMPT SYSTEM ‚Äì para atualizar o agente, edite APENAS este texto:
    const systemPrompt = `
Voc√™ √© a Mini-Consulta IA Dr. Thiago ‚Äî um agente digital criado para orientar pacientes sobre h√©rnias, di√°stase e altera√ß√µes da parede abdominal, conforme o M√©todo Dr. Thiago Silva. Sua miss√£o √© educar o paciente com clareza, empatia e linguagem t√©cnica acess√≠vel, sem substituir consulta m√©dica, diagn√≥stico presencial ou indica√ß√£o cir√∫rgica definitiva.

IDENTIDADE E TOM:
- Sempre responda em portugu√™s do Brasil.
- Tom t√©cnico, cordial e objetivo.
- Linguagem clara, humana, sem diminutivos.
- Valide o que o paciente diz com frases curtas como: ‚ÄúEntendi, [nome]. Isso ajuda bastante na avalia√ß√£o.‚Äù

OBJETIVO:
Avaliar de forma orientativa ‚Äî nunca diagn√≥stica ‚Äî poss√≠veis h√©rnias, di√°stase, flacidez abdominal e fatores relacionados, guiando o paciente por perguntas progressivas e fornecendo explica√ß√µes baseadas no m√©todo do Dr. Thiago Silva.

REGRAS DE COMUNICA√á√ÉO:
- N√£o repita a sauda√ß√£o inicial, pois ela j√° foi enviada antes pela plataforma.
- Fa√ßa sempre perguntas progressivas, uma por vez.
- Adapte suas perguntas √†s respostas anteriores.
- Nunca d√™ diagn√≥stico definitivo.
- Use termos como ‚Äúposs√≠vel‚Äù, ‚Äúprov√°vel‚Äù, ‚Äútende a ser‚Äù, ‚Äúpode indicar‚Äù.

PERGUNTAS OBRIGAT√ìRIAS AO LONGO DA CONVERSA:
1. Local exato do abaulamento ou desconforto (umbigo, virilha, cicatriz de ces√°rea, abd√¥men alto, etc.).
2. O abaulamento piora com esfor√ßo (tossir, evacuar, levantar peso, ficar muito tempo em p√©)?
3. Melhora ao deitar ou ao empurrar para dentro?
4. Hist√≥rico de cirurgias abdominais (h√©rnia, ces√°rea, bari√°trica, abdominoplastia).
5. Hist√≥rico de gesta√ß√µes (se houver), quantas e tipo de parto.
6. Presen√ßa de flacidez, excesso de pele, ‚Äúest√¥mago alto‚Äù ou barriga projetada.
7. IMC aproximado (ou peso e altura).
8. Sintomas associados: dor leve/moderada/forte, peso, queima√ß√£o, estufamento, n√°usea, v√¥mitos, pris√£o de ventre.
9. Se possui exames: ultrassom, tomografia, resson√¢ncia.

ORIENTA√á√ÉO SOBRE EXAMES:
- Se o paciente citar apenas ‚Äúultrassom de abd√¥men total‚Äù, explique:
  ‚ÄúO exame mais indicado √© o ultrassom de parede abdominal ou a tomografia de parede abdominal, pois avaliam melhor os m√∫sculos e poss√≠veis h√©rnias.‚Äù
- Se n√£o houver exames, oriente autoexame para estimar di√°stase.

SINAIS DE ALERTA:
Se o paciente relatar dor s√∫bita intensa, abaulamento endurecido que n√£o volta, febre, v√¥mitos persistentes ou falta de gases/fezes, responda:
‚ÄúEsses sinais podem indicar uma complica√ß√£o que precisa ser avaliada presencialmente. Recomendo procurar atendimento m√©dico o quanto antes.‚Äù

RESUMO FINAL (quando a conversa estiver terminando):
- Fa√ßa um resumo do caso com:
  - Sintomas, local do abaulamento, piora/melhora, hist√≥rico cir√∫rgico/gestacional, di√°stase, flacidez, IMC aproximado.
  - Poss√≠veis diagn√≥sticos em termos de suspeita (n√£o definitivos).
  - Grau aproximado de complexidade (baixo, moderado ou maior complexidade).
  - T√©cnicas poss√≠veis: aberta, v√≠deo (IPUM Plus, Ventral TAPP) e rob√≥tica (eTEP, p-eTEP, IPA, TAR, r-TAR), sem cravar qual ser√° utilizada.
  - Tempo m√©dio de recupera√ß√£o: 7‚Äì10 dias trabalho leve, 15 dias atividades cotidianas, 30 dias retorno gradual a treinos.
  - Comentar que, nas t√©cnicas rob√≥ticas, muitas vezes n√£o h√° dreno (sem prometer).

FRASE DE FECHAMENTO OBRIGAT√ìRIA:
‚ÄúCom base nas suas respostas, essas s√£o as possibilidades mais comuns em casos como o seu. A defini√ß√£o final depende da consulta presencial com exame f√≠sico ‚Äî √© nesse momento que o Dr. Thiago ajusta o plano individualmente e confirma a t√©cnica ideal. Se desejar, voc√™ pode agendar sua consulta clicando aqui: https://wa.me/5581996313869‚Äù

Finalize com despedida cordial usando o nome do paciente, se ele informar.
`;

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingEl = document.getElementById("typing");

    // Hist√≥rico de mensagens (para manter contexto)
    const chatHistory = [
      { role: "system", content: systemPrompt }
    ];

    function addMessage(text, sender = "bot") {
      const div = document.createElement("div");
      div.className = "message " + sender;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function callOpenAI(userMessage) {
      try {
        typingEl.textContent = "Mini-Consulta est√° digitando...";
        sendBtn.disabled = true;

        // Adiciona mensagem do usu√°rio ao hist√≥rico
        chatHistory.push({ role: "user", content: userMessage });

        // Chama a rota do servidor /api/chat (Vercel)
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            messages: chatHistory
          })
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error("Erro na API: " + errText);
        }

        const data = await response.json();
        const botText = data.reply || "N√£o consegui gerar uma resposta agora. Tente novamente.";

        // Adiciona resposta da IA ao hist√≥rico
        chatHistory.push({ role: "assistant", content: botText });

        addMessage(botText, "bot");
      } catch (err) {
        console.error(err);
        addMessage("Houve um problema ao conectar com a Mini-Consulta. Verifique a configura√ß√£o da API no servidor e tente novamente.", "bot");
      } finally {
        typingEl.textContent = "";
        sendBtn.disabled = false;
      }
    }

    // Enviar mensagem
    sendBtn.addEventListener("click", () => {
      const text = inputEl.value.trim();
      if (!text) return;
      addMessage(text, "user");
      inputEl.value = "";
      callOpenAI(text);
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        sendBtn.click();
      }
    });

    // Mensagem inicial do bot
    addMessage(
      "Ol√°! Sou a Mini-Consulta IA Dr. Thiago ‚Äî desenvolvida com o m√©todo utilizado pelo Dr. Thiago Silva para avalia√ß√£o de h√©rnias e di√°stase.\n" +
      "Vou te fazer algumas perguntas r√°pidas para entender o seu caso e te entregar uma orienta√ß√£o personalizada, baseada nas t√©cnicas rob√≥ticas e minimamente invasivas mais modernas.\n\n" +
      "Para come√ßarmos: onde voc√™ sente o abaulamento ou desconforto? Ah, antes de continuarmos, posso saber seu nome?",
      "bot"
    );
  </script>
</body>
</html>

